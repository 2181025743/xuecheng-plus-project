# 快速开始：分片广播测试

> 5 分钟快速测试分片广播功能

## 🎯 目标

启动 2 个执行器实例，测试分片广播机制，观察分片参数。

---

## 📝 前置条件

- ✅ XXL-JOB Admin 已启动（http://127.0.0.1:8080/xxl-job-admin）
- ✅ Nacos 已启动
- ✅ MySQL 已启动
- ✅ 代码已更新（包含 shardingJobHandler 方法）

---

## 🚀 操作步骤

### 步骤 1：启动第一个执行器（默认实例）

**方式：** 直接运行`MediaApplication`主类

**端口：**

- 服务端口：`63050`
- 执行器端口：`9999`

**验证：** 控制台看到启动成功日志

---

### 步骤 2：启动第二个执行器

#### 方法 A：IDEA 配置（推荐）

1. **复制启动配置**

   - 点击 IDEA 右上角运行配置下拉框
   - 选择 "Edit Configurations..."
   - 找到 `MediaApplication`
   - 右键 → "Copy Configuration"

2. **修改配置**

   - Name 改为：`MediaApplication-9998`
   - 在 **VM options** 中添加：
     ```
     -Dserver.port=63051 -Dxxl.job.executor.port=9998
     ```
   - 点击 Apply → OK

3. **启动第二个实例**
   - 选择 `MediaApplication-9998` 配置
   - 点击运行按钮

#### 方法 B：命令行（备选）

```bash
# 在项目根目录执行
cd xuecheng-plus-media/xuecheng-plus-media-api

# 启动第二个实例
mvn spring-boot:run -Dspring-boot.run.arguments="--server.port=63051 --xxl.job.executor.port=9998"
```

---

### 步骤 3：验证执行器在线

1. 访问：http://127.0.0.1:8080/xxl-job-admin
2. 登录：admin / 123456
3. 进入：**执行器管理**
4. 找到：`media-service-executor`
5. 查看在线机器：

```
✅ 应该看到2个地址：
127.0.0.1:9999
127.0.0.1:9998
```

**如果只看到 1 个或 0 个？**

- 检查服务是否真的启动成功
- 检查日志是否有错误
- 检查端口是否冲突

---

### 步骤 4：添加分片广播任务

1. 进入 **任务管理** → 点击 **新增**

2. 填写以下配置：

| 配置项         | 值                          |
| -------------- | --------------------------- |
| 执行器         | `media-service-executor`    |
| 任务描述       | `分片广播测试任务`          |
| 负责人         | `admin`                     |
| 调度类型       | `CRON`                      |
| Cron           | `0/5 * * * * ?`             |
| 运行模式       | `BEAN`                      |
| **JobHandler** | **`shardingJobHandler`** ⭐ |
| **路由策略**   | **`分片广播`** ⭐⭐⭐       |
| 阻塞处理策略   | `单机串行`                  |

3. 点击 **保存**

---

### 步骤 5：启动任务并查看日志

1. **启动任务**

   - 在任务列表找到刚创建的任务
   - 点击 **启动** 按钮

2. **查看执行日志**

   - 点击任务后面的 **执行日志** 按钮
   - 等待 5 秒钟，应该看到 2 条执行记录

3. **点击"执行日志"查看详情**

**执行器 1 的日志（9999）：**

```
========== 分片广播任务执行 ==========
分片参数 → 当前分片序号: 0, 总分片数: 2
执行时间：2025-10-09 14:30:05
【执行器 0】开始处理属于自己的数据分片...
【执行器 0】处理逻辑：查询 id % 2 = 0 的数据
【执行器 0】数据处理完成！
========== 分片广播任务完成 ==========
```

**执行器 2 的日志（9998）：**

```
========== 分片广播任务执行 ==========
分片参数 → 当前分片序号: 1, 总分片数: 2
执行时间：2025-10-09 14:30:05
【执行器 1】开始处理属于自己的数据分片...
【执行器 1】处理逻辑：查询 id % 2 = 1 的数据
【执行器 1】数据处理完成！
========== 分片广播任务完成 ==========
```

---

## ✅ 成功标志

如果看到以下现象，说明分片广播配置成功：

1. ✅ 每次调度有**2 条**执行记录（不是 1 条）
2. ✅ 两条记录的执行时间**几乎相同**（并行执行）
3. ✅ 一个日志显示 `shardIndex=0`，另一个显示 `shardIndex=1`
4. ✅ 两个日志都显示 `shardTotal=2`

---

## 🔬 进阶测试：动态扩容

### 测试目的

验证 XXL-JOB 的动态扩容能力

### 操作步骤

1. **保持任务运行**（不要停止）

2. **启动第 3 个执行器**

   - 复制配置，命名为 `MediaApplication-9997`
   - VM options：
     ```
     -Dserver.port=63052 -Dxxl.job.executor.port=9997
     ```
   - 启动

3. **观察执行器管理**

   - 应该看到 3 个执行器在线

4. **观察下一次调度的日志**

   - 应该有**3 条**执行记录
   - shardIndex 分别为：0, 1, 2
   - **shardTotal 自动变成 3** ⭐

5. **停止第 3 个执行器**
   - 观察下一次调度
   - **shardTotal 自动变回 2** ⭐

**结论**：XXL-JOB 会自动识别执行器数量变化，无需修改配置！

---

## 🎓 核心理解

### 1. 分片广播的本质

```
普通路由策略（轮询、随机等）：
调度中心 → 选1个执行器 → 执行任务

分片广播：
调度中心 → 通知所有执行器 → 同时执行任务
         ↓
    给每个执行器分配序号（shardIndex）
    告诉总共有几个执行器（shardTotal）
```

### 2. 如何避免重复执行？

通过 **取模** 运算分配数据：

```sql
-- 假设有100个视频，2个执行器

执行器1（shardIndex=0）：
SELECT * FROM media_process
WHERE status = '待转码'
AND MOD(id, 2) = 0  -- id=0,2,4,6,8...（50个）

执行器2（shardIndex=1）：
SELECT * FROM media_process
WHERE status = '待转码'
AND MOD(id, 2) = 1  -- id=1,3,5,7,9...（50个）
```

**关键**：每个执行器处理的数据不重叠！

### 3. 适用场景

✅ **适合分片广播**：

- 大批量数据处理（视频转码、数据同步）
- 数据可以按 ID 分片
- 需要最大化处理速度

❌ **不适合分片广播**：

- 单次性任务（定时清理、报表生成）
- 数据无法分片
- 只需单节点执行

---

## 🐛 常见问题

### Q1: 只看到 1 条执行日志，不是 2 条？

**原因**：路由策略不是"分片广播"

**解决**：

1. 编辑任务
2. 路由策略改为：**分片广播（SHARDING_BROADCAST）**
3. 保存

---

### Q2: shardIndex 和 shardTotal 都是 0？

**原因**：路由策略不是"分片广播"

**解决**：同 Q1

---

### Q3: 执行器显示离线？

**可能原因**：

1. 端口冲突（9998/9999 已被占用）
2. 配置错误
3. 网络问题

**解决**：

```bash
# Windows检查端口
netstat -ano | findstr 9999
netstat -ano | findstr 9998

# 如果被占用，换个端口
-Dxxl.job.executor.port=9996
```

---

### Q4: 第二个实例启动失败？

**错误信息**：`Port 63050 already in use`

**原因**：忘记修改 server.port

**解决**：确保 VM options 包含：

```
-Dserver.port=63051 -Dxxl.job.executor.port=9998
```

---

## 📚 下一步学习

测试成功后，可以继续学习：

1. **实现视频转码任务** → 参考 `XXL-JOB分片广播实战指南.md`
2. **了解其他路由策略** → 参考 `XXL-JOB任务配置指南.md`
3. **学习阻塞处理策略** → 避免任务重复执行
4. **学习调度过期策略** → 处理任务漏执行

---

## 🎉 总结

恭喜你完成分片广播测试！

**你已经掌握**：

- ✅ 如何启动多个执行器实例
- ✅ 如何配置分片广播任务
- ✅ 如何查看分片参数
- ✅ 理解分片广播的工作原理
- ✅ 验证动态扩容机制

**核心要点**：

1. **分片广播** = 所有执行器同时工作
2. **shardIndex** = 执行器序号（从 0 开始）
3. **shardTotal** = 执行器总数
4. **取模运算** = 避免数据重复处理

继续加油！🚀
