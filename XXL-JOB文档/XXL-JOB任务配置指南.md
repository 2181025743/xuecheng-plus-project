# XXL-JOB 任务配置指南

## 📋 任务列表

### 1. 测试任务（testJob）

**用途**：验证 XXL-JOB 集成是否正常

**推荐配置**：

- **调度类型**：CRON
- **Cron 表达式**：`0/10 * * * * ?` （每 10 秒执行一次）
- **路由策略**：FIRST（第一个）
- **阻塞策略**：单机串行（SERIAL_EXECUTION）
- **调度过期策略**：忽略
- **失败重试次数**：0

---

### 2. 分块文件清理任务（chunkCleanupJob）

**用途**：每天定时清理过期的分块文件

**推荐配置**：

- **调度类型**：CRON
- **Cron 表达式**：`0 0 2 * * ?` （每天凌晨 2 点执行）
- **路由策略**：FIRST（第一个）
- **阻塞策略**：单机串行（SERIAL_EXECUTION）
- **调度过期策略**：立即执行一次（FIRE_ONCE_NOW）
- **失败重试次数**：1
- **任务超时时间**：1800 秒（30 分钟）

**说明**：

- 使用 FIRST 策略，只需要一个节点执行清理即可
- 如果凌晨 2 点因故未执行，补偿执行一次

---

### 3. 分片广播测试任务（shardingJobHandler）⭐⭐⭐ 重点

**用途**：测试分片广播机制，理解分片参数的工作原理

**推荐配置**：

- **调度类型**：CRON
- **Cron 表达式**：`0/5 * * * * ?` （每 5 秒执行一次）
- **路由策略**：分片广播（SHARDING_BROADCAST）⭐ **最关键的配置**
- **阻塞策略**：单机串行（SERIAL_EXECUTION）
- **调度过期策略**：忽略
- **失败重试次数**：0

**核心功能**：

1. 打印当前执行器的分片参数（shardIndex、shardTotal）
2. 验证多个执行器是否同时执行任务
3. 演示如何根据分片参数处理不同的数据

**使用场景**：

- ✅ 测试分片广播是否正常工作
- ✅ 理解分片参数的含义
- ✅ 验证动态扩容机制

**测试步骤**：

1. 启动至少 2 个 media-service 实例（参考下方"启动多节点执行器"）
2. 在 XXL-JOB Admin 中添加此任务，路由策略选择"分片广播"
3. 启动任务，查看执行日志
4. 应该看到两个执行器同时执行，且 shardIndex 不同

**期望日志输出**：

```
执行器1：分片参数 → 当前分片序号: 0, 总分片数: 2
执行器2：分片参数 → 当前分片序号: 1, 总分片数: 2
```

---

### 4. 视频转码任务（videoTranscodeJob）⭐⭐⭐ 重点

**用途**：分布式处理待转码视频（生产环境使用）

**推荐配置**：

- **调度类型**：CRON
- **Cron 表达式**：`0 0/5 * * * ?` （每 5 分钟执行一次）
- **路由策略**：分片广播（SHARDING_BROADCAST）⭐ **核心配置**
- **阻塞策略**：单机串行（SERIAL_EXECUTION）
- **调度过期策略**：忽略
- **失败重试次数**：2
- **任务超时时间**：3600 秒（1 小时）

**分片广播原理**：

```
假设有3个media-service节点：
- 节点1（端口9999）：shardIndex=0, shardTotal=3
- 节点2（端口9998）：shardIndex=1, shardTotal=3
- 节点3（端口9997）：shardIndex=2, shardTotal=3

查询待转码视频时，使用取模方式分片：
节点1处理：video_id % 3 = 0 的视频
节点2处理：video_id % 3 = 1 的视频
节点3处理：video_id % 3 = 2 的视频
```

**代码实现示例**：

```java
@XxlJob("videoTranscodeJob")
public void videoTranscodeJob() {
    // 获取分片参数
    int shardIndex = XxlJobHelper.getShardIndex();
    int shardTotal = XxlJobHelper.getShardTotal();

    // 查询当前分片应该处理的视频
    // SELECT * FROM media_process
    // WHERE status = '待转码'
    // AND MOD(id, #{shardTotal}) = #{shardIndex}
    // LIMIT 100

    // 处理视频...
}
```

---

### 5. 参数任务（paramJob）

**用途**：演示如何使用任务参数

**推荐配置**：

- **调度类型**：CRON
- **Cron 表达式**：按需配置
- **路由策略**：FIRST
- **任务参数**：可以在调度中心配置参数，如：`{"type":"cleanup","days":7}`

---

## 🎯 配置要点总结

### 何时使用分片广播？

✅ **使用场景**：

- 需要处理大量数据（如视频转码、数据同步）
- 希望多个节点同时工作，提高处理速度
- 数据可以按某种规则分片（如 ID 取模）

❌ **不适用场景**：

- 只需要单节点执行的任务（如定时清理、报表生成）
- 任务无法分片的场景

### 阻塞策略选择

- **数据一致性要求高**：单机串行
- **允许跳过执行**：丢弃后续调度
- **实时性要求高**：覆盖之前调度

### 调度过期策略选择

- **不能漏执行的任务**：立即执行一次
- **可以跳过的任务**：忽略

---

## 🚀 启动多节点执行器

### 方法 1：IDEA 配置多实例

1. 复制启动配置
2. 修改 VM 参数：`-Dserver.port=63051 -Dxxl.job.executor.port=9998`
3. 启动第二个实例

### 方法 2：命令行启动

```bash
# 第一个节点（默认配置）
java -jar media-api.jar --server.port=63050 --xxl.job.executor.port=9999

# 第二个节点
java -jar media-api.jar --server.port=63051 --xxl.job.executor.port=9998

# 第三个节点
java -jar media-api.jar --server.port=63052 --xxl.job.executor.port=9997
```

### 验证分片效果

在 XXL-JOB 调度中心查看执行日志，应该看到：

```
[节点1] 分片参数：当前分片 = 1/3
[节点2] 分片参数：当前分片 = 2/3
[节点3] 分片参数：当前分片 = 3/3
```

---

## 📊 监控与运维

### 查看执行日志

- 登录 XXL-JOB Admin：http://127.0.0.1:8080/xxl-job-admin
- 用户名/密码：admin/123456
- 进入"调度日志"查看执行情况

### 常见问题

1. **任务不执行**：检查执行器是否在线
2. **重复执行**：检查阻塞策略配置
3. **执行器离线**：检查网络和 executor 配置

---

## 📖 参考文档

- XXL-JOB 官方文档：查看项目中的 `xxl-job-2.3.1/doc/XXL-JOB官方文档.md`
- 其他集成文档：
  - `XXL-JOB快速启动指南.md`
  - `XXL-JOB集成指南.md`
  - `XXL-JOB集成完成总结.md`
