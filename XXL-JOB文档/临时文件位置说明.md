# 临时文件位置说明

## 一、你的应用服务器临时文件位置

### 📂 分块文件存储位置

**路径**：`C:\Users\a3351\AppData\Local\Temp\xc-chunks\`

**完整路径示例**：

```
C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b\
├── 0  (5.0MB)
├── 1  (5.0MB)
├── 2  (5.0MB)
└── 3  (5.0MB)
```

### 🔍 当前发现

我在你的临时目录中发现了一个**上传失败的视频分块**：

- **MD5**: `e06287e20c6a09d16d12ce764f9b0a1b`
- **已上传分块**: 0, 1, 2, 3（共 4 块，每块 5MB）
- **总大小**: 20MB
- **最后修改时间**: 2025-10-07 23:02
- **状态**: ❌ 上传未完成（数据库中无记录）

这就是典型的**垃圾分块文件**，需要清理！

---

## 二、临时文件的完整路径

### 2.1 Java 如何获取临时目录？

```java
// MediaFileServiceImpl.java - getChunkRootPath 方法
private Path getChunkRootPath(String fileMd5) {
    String base = System.getProperty("java.io.tmpdir");  // ← 获取系统临时目录
    return Paths.get(base, "xc-chunks", fileMd5);
}
```

**在 Windows 上，`java.io.tmpdir` 返回**：

```
C:\Users\a3351\AppData\Local\Temp
```

**因此分块目录是**：

```
C:\Users\a3351\AppData\Local\Temp\xc-chunks\{文件MD5}\
```

### 2.2 合并临时文件位置

```java
// MediaFileServiceImpl.java - mergechunks 方法
Path merged = Files.createTempFile("xc-merge-", ".tmp");
```

**位置**：

```
C:\Users\a3351\AppData\Local\Temp\xc-merge-随机数.tmp
```

**示例**：

```
C:\Users\a3351\AppData\Local\Temp\xc-merge-abc123.tmp
```

---

## 三、如何查看你的临时文件

### 方法 1：通过文件资源管理器

1. 按 `Win + R` 打开运行
2. 输入：`%TEMP%` 或 `C:\Users\a3351\AppData\Local\Temp`
3. 回车
4. 查找 `xc-chunks` 文件夹

### 方法 2：通过命令行

```bash
# 查看分块目录列表
ls -la "C:\Users\a3351\AppData\Local\Temp\xc-chunks"

# 查看某个分块目录的内容
ls -lh "C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5值}"

# 统计分块文件占用的空间
du -sh "C:\Users\a3351\AppData\Local\Temp\xc-chunks"
```

### 方法 3：通过 Git Bash（你正在用的）

```bash
cd /c/Users/a3351/AppData/Local/Temp/xc-chunks
ls -la
```

---

## 四、当前临时文件分析

### 4.1 发现的分块文件

```bash
$ ls -lh C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b

total 20M
-rw-r--r-- 1 a3351 197609 5.0M 10月  7 23:02 0
-rw-r--r-- 1 a3351 197609 5.0M 10月  7 23:02 1
-rw-r--r-- 1 a3351 197609 5.0M 10月  7 23:02 2
-rw-r--r-- 1 a3351 197609 5.0M 10月  7 23:02 3
```

### 4.2 分析结果

**文件信息**：

- MD5: `e06287e20c6a09d16d12ce764f9b0a1b`
- 已上传: 4 块（0, 1, 2, 3）
- 每块大小: 5.0MB
- 总大小: 20MB
- 创建时间: 2025-10-07 23:02（约 15 分钟前）

**推测**：

- 这是你最近上传的视频
- 只上传了 4 块就中断了（可能是网络问题或主键冲突）
- 由于合并失败，这 4 块文件仍然保存在临时目录
- 这就是需要清理的**垃圾文件**

### 4.3 为什么上传失败？

可能的原因：

1. 主键冲突（数据库中已有相同 MD5 的记录）
2. 网络中断
3. 前端合并请求失败
4. 后端合并过程异常

---

## 五、清理这些临时文件

### 立即手动清理

```bash
# 删除这个分块目录
rm -rf "C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b"

# 或者清空整个xc-chunks目录
rm -rf "C:\Users\a3351\AppData\Local\Temp\xc-chunks"/*
```

### 使用 Windows 命令

```cmd
# 在CMD中执行
rd /s /q "C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b"
```

---

## 六、完整的文件路径总结

### Windows 环境下的所有临时文件位置

```
C:\Users\a3351\AppData\Local\Temp\
├── xc-chunks\                           ← 分块文件根目录
│   ├── e06287e20c6a09d16d12ce764f9b0a1b\  ← 某个文件的分块目录（MD5作为目录名）
│   │   ├── 0                            ← 第1块（5MB）
│   │   ├── 1                            ← 第2块（5MB）
│   │   ├── 2                            ← 第3块（5MB）
│   │   └── 3                            ← 第4块（5MB）
│   │
│   └── 另一个文件MD5\                    ← 如果有其他文件上传
│       ├── 0
│       ├── 1
│       └── ...
│
└── xc-merge-随机数.tmp                  ← 合并后的临时文件（仅合并时存在）
    └── 例如：xc-merge-abc123.tmp
```

### 文件生命周期

```
1. 用户开始上传
   ↓
2. 创建分块目录
   C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\
   ↓
3. 逐个保存分块
   C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\0
   C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\1
   ...
   ↓
4. 所有分块上传完成，调用合并
   ↓
5. 创建合并临时文件
   C:\Users\a3351\AppData\Local\Temp\xc-merge-abc123.tmp
   ↓
6. 读取所有分块，写入合并文件
   ↓
7. MD5校验
   ↓
8. 上传到OSS（完整文件）
   ↓
9. 入库
   ↓
10. 清理临时文件 ✅
    - 删除 C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\0
    - 删除 C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\1
    - ...
    - 删除目录 C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\
    - 删除 C:\Users\a3351\AppData\Local\Temp\xc-merge-abc123.tmp
```

---

## 七、如何避免垃圾文件积累

### 当前问题

你的临时目录中有一个上传失败的分块目录（`e06287e20c6a09d16d12ce764f9b0a1b`），占用 20MB 空间。

### 解决方案

#### 方案 1：手动清理（临时方案）

```bash
# 清空所有分块目录
rm -rf "C:\Users\a3351\AppData\Local\Temp\xc-chunks"/*
```

#### 方案 2：定时任务自动清理（推荐）

参考 `分块文件清理机制实现方案.md` 中的方案，创建定时任务每天自动清理超过 24 小时的分块文件。

---

## 八、验证断点续传

现在你可以亲自验证断点续传功能：

### 步骤 1：重新上传之前失败的文件

1. 在媒资管理中上传同一个视频（MD5 会是 `e06287e20c6a09d16d12ce764f9b0a1b`）
2. 前端会检查服务器上已有的分块
3. 块 0-3 会被**跳过**（因为已存在）
4. 只会上传块 4 及后续的块

### 步骤 2：观察控制台

打开浏览器控制台（F12），你会看到类似的输出：

```
success:: {num: 0, chunkCount: X, state: 'uploading'}  // 跳过块0
success:: {num: 1, chunkCount: X, state: 'uploading'}  // 跳过块1
success:: {num: 2, chunkCount: X, state: 'uploading'}  // 跳过块2
success:: {num: 3, chunkCount: X, state: 'uploading'}  // 跳过块3
success:: {num: 4, chunkCount: X, state: 'uploading'}  // 开始上传块4
...
```

### 步骤 3：查看临时目录

```bash
ls -lh "C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b"
```

会看到更多分块文件：

```
0  (5.0MB) ← 之前已有
1  (5.0MB) ← 之前已有
2  (5.0MB) ← 之前已有
3  (5.0MB) ← 之前已有
4  (5.0MB) ← 新上传
5  (5.0MB) ← 新上传
...
```

### 步骤 4：上传成功后

```bash
ls -lh "C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b"
# 输出：ls: cannot access ...: No such file or directory
```

目录被清空了！✅

---

## 九、快速清理当前垃圾文件

让我帮你立即清理这个占用 20MB 的垃圾目录：

```bash
# 执行清理
rm -rf "C:\Users\a3351\AppData\Local\Temp\xc-chunks\e06287e20c6a09d16d12ce764f9b0a1b"

# 验证清理结果
ls -la "C:\Users\a3351\AppData\Local\Temp\xc-chunks"
# 应该看到目录为空或不存在
```

---

## 十、总结

### 你的临时文件位置

✅ **分块文件**：`C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\0, 1, 2, ...`  
✅ **合并文件**：`C:\Users\a3351\AppData\Local\Temp\xc-merge-随机数.tmp`  
✅ **最终文件**：阿里云 OSS（`https://yangxiaobucker.oss-cn-beijing.aliyuncs.com/2025/10/07/{MD5}.mp4`）

### 当前状态

- **发现 1 个垃圾目录**：`e06287e20c6a09d16d12ce764f9b0a1b`（4 块，20MB）
- **原因**：上传失败，未完成合并
- **影响**：占用 20MB 磁盘空间
- **建议**：立即清理或等待定时任务清理

### 文件流转路径

```
浏览器内存（分块）
    ↓
C:\Users\a3351\AppData\Local\Temp\xc-chunks\{MD5}\0,1,2,... （分块保存）
    ↓
C:\Users\a3351\AppData\Local\Temp\xc-merge-xxx.tmp （合并后的完整文件）
    ↓
阿里云OSS: yangxiaobucker/2025/10/07/{MD5}.mp4 （最终存储）
    ↓
临时文件全部删除 ✅
```

**现在你清楚临时文件在哪里了吧！** ✅
