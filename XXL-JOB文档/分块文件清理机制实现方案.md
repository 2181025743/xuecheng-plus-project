# åˆ†å—æ–‡ä»¶æ¸…ç†æœºåˆ¶å®ç°æ–¹æ¡ˆ

## ä¸€ã€é—®é¢˜èƒŒæ™¯

### 1.1 æ–­ç‚¹ç»­ä¼ æµç¨‹å›é¡¾

**å‰ç«¯åˆ†å—ä¸Šä¼ æµç¨‹**ï¼š

```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼ˆ100MBï¼‰
â†“
åˆ†å—ï¼ˆ5MB Ã— 20å—ï¼‰
â†“
é€å—ä¸Šä¼ ï¼š
  ç¬¬1å— â†’ checkchunk â†’ ä¸å­˜åœ¨ â†’ uploadchunk â†’ æˆåŠŸ
  ç¬¬2å— â†’ checkchunk â†’ ä¸å­˜åœ¨ â†’ uploadchunk â†’ æˆåŠŸ
  ...
  ç¬¬10å— â†’ checkchunk â†’ ä¸å­˜åœ¨ â†’ uploadchunk â†’ âŒ ç½‘ç»œä¸­æ–­

ç”¨æˆ·é‡æ–°ä¸Šä¼ ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰ï¼š
  ç¬¬1å— â†’ checkchunk â†’ å·²å­˜åœ¨ â†’ è·³è¿‡ âœ…
  ç¬¬2å— â†’ checkchunk â†’ å·²å­˜åœ¨ â†’ è·³è¿‡ âœ…
  ...
  ç¬¬10å— â†’ checkchunk â†’ ä¸å­˜åœ¨ â†’ uploadchunk â†’ æˆåŠŸ
  ...
  ç¬¬20å— â†’ checkchunk â†’ ä¸å­˜åœ¨ â†’ uploadchunk â†’ æˆåŠŸ

æ‰€æœ‰åˆ†å—ä¸Šä¼ å®Œæˆ
â†“
mergeChunks â†’ åˆå¹¶ â†’ MD5æ ¡éªŒ â†’ ä¸Šä¼ OSS â†’ å…¥åº“ â†’ æ¸…ç†åˆ†å— âœ…
```

### 1.2 å­˜åœ¨çš„é—®é¢˜

**åœºæ™¯ 1ï¼šä¸Šä¼ ä¸€åŠæ”¾å¼ƒ**

- ç”¨æˆ·ä¸Šä¼ äº† 50 å—ï¼Œç„¶åå…³é—­é¡µé¢
- è¿™ 50 å—åˆ†å—æ–‡ä»¶ä¿å­˜åœ¨æœåŠ¡å™¨ä¸´æ—¶ç›®å½•
- âŒ **æ°¸è¿œä¸ä¼šè¢«æ¸…ç†ï¼Œæˆä¸ºåƒåœ¾æ–‡ä»¶**

**åœºæ™¯ 2ï¼šä¸Šä¼ å¤±è´¥**

- ç”¨æˆ·ä¸Šä¼ å®Œæ‰€æœ‰åˆ†å—ï¼Œä½†åˆå¹¶æ—¶å¤±è´¥ï¼ˆMD5 æ ¡éªŒå¤±è´¥ã€OSS ä¸Šä¼ å¤±è´¥ç­‰ï¼‰
- æ‰€æœ‰åˆ†å—æ–‡ä»¶ä»ç„¶ä¿å­˜åœ¨ä¸´æ—¶ç›®å½•
- âŒ **å¯èƒ½ä¸ä¼šè¢«æ¸…ç†**

**åœºæ™¯ 3ï¼šæœåŠ¡å™¨é‡å¯**

- ä¸Šä¼ è¿‡ç¨‹ä¸­æœåŠ¡å™¨é‡å¯
- åˆ†å—æ–‡ä»¶ä¿å­˜åœ¨ä¸´æ—¶ç›®å½•ï¼ˆå¦‚ `/tmp/xc-chunks/`ï¼‰
- åœ¨ Linux ä¸Šï¼Œ`/tmp` ç›®å½•é‡å¯åå¯èƒ½è¢«æ¸…ç©ºï¼ˆå–å†³äºç³»ç»Ÿé…ç½®ï¼‰
- åœ¨ Windows ä¸Šï¼Œä¸´æ—¶ç›®å½•ä¸ä¼šè‡ªåŠ¨æ¸…ç©º
- âŒ **Windows ç¯å¢ƒä¸‹ä¼šç§¯ç´¯åƒåœ¾æ–‡ä»¶**

### 1.3 å½±å“

- ç£ç›˜ç©ºé—´æµªè´¹
- ä¸´æ—¶ç›®å½•æ–‡ä»¶è¿‡å¤šï¼Œå½±å“æ€§èƒ½
- æ— æ³•è¿½è¸ªå“ªäº›æ˜¯æ­£å¸¸æ–‡ä»¶ï¼Œå“ªäº›æ˜¯åƒåœ¾æ–‡ä»¶

---

## äºŒã€è§£å†³æ–¹æ¡ˆè®¾è®¡

### 2.1 æ–¹æ¡ˆé€‰æ‹©

#### æ–¹æ¡ˆ 1ï¼šåŸºäºæ•°æ®åº“çŠ¶æ€çš„æ¸…ç†ï¼ˆè§†é¢‘ä¸­çš„æ–¹æ¡ˆï¼‰

**æ€è·¯**ï¼š

1. åœ¨ `media_files` è¡¨ä¸­å¢åŠ  `upload_status` å­—æ®µ
2. ä¸Šä¼ å¼€å§‹æ—¶æ’å…¥è®°å½•ï¼ŒçŠ¶æ€ä¸º"ä¸Šä¼ ä¸­"
3. ä¸Šä¼ æˆåŠŸåæ›´æ–°çŠ¶æ€ä¸º"å·²å®Œæˆ"
4. å®šæ—¶ä»»åŠ¡æ‰«æ"ä¸Šä¼ ä¸­"ä¸”è¶…è¿‡ 24 å°æ—¶çš„è®°å½•
5. åˆ é™¤å¯¹åº”çš„åˆ†å—æ–‡ä»¶å’Œæ•°æ®åº“è®°å½•

**ä¼˜ç‚¹**ï¼š

- å¯è¿½è¸ªæ‰€æœ‰ä¸Šä¼ ä»»åŠ¡
- ç²¾å‡†æ¸…ç†
- æœ‰å®¡è®¡è®°å½•

**ç¼ºç‚¹**ï¼š

- éœ€è¦ä¿®æ”¹è¡¨ç»“æ„
- ä¸Šä¼ å¼€å§‹å°±è¦å†™æ•°æ®åº“ï¼ˆå³ä½¿æœ€ç»ˆå¯èƒ½ä¸ä¸Šä¼ ï¼‰

#### æ–¹æ¡ˆ 2ï¼šåŸºäºæ–‡ä»¶æ—¶é—´æˆ³çš„æ¸…ç†ï¼ˆæ¨èï¼‰

**æ€è·¯**ï¼š

1. ä¸ä¿®æ”¹æ•°æ®åº“ç»“æ„
2. å®šæ—¶ä»»åŠ¡ç›´æ¥æ‰«æä¸´æ—¶ç›®å½•
3. æ£€æŸ¥åˆ†å—ç›®å½•çš„æœ€åä¿®æ”¹æ—¶é—´
4. å¦‚æœè¶…è¿‡ 24 å°æ—¶ï¼Œç›´æ¥åˆ é™¤æ•´ä¸ªåˆ†å—ç›®å½•

**ä¼˜ç‚¹**ï¼š

- å®ç°ç®€å•
- ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“
- é€‚ç”¨äºæ‰€æœ‰æœªå®Œæˆçš„ä¸Šä¼ 

**ç¼ºç‚¹**ï¼š

- æ— æ³•è¿½è¸ªå…·ä½“æ˜¯å“ªä¸ªæ–‡ä»¶
- æ— å®¡è®¡è®°å½•

#### æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

**æ€è·¯**ï¼š

1. åˆ©ç”¨ç°æœ‰çš„ `status` å­—æ®µï¼ˆ1-æ­£å¸¸ï¼Œ0-åˆ é™¤ï¼‰
2. æ–°å¢ `upload_status` å­—æ®µï¼ˆuploading/completed/failedï¼‰
3. åˆå¹¶æ—¶æ‰æ’å…¥æ•°æ®åº“è®°å½•ï¼ŒçŠ¶æ€ä¸º"uploading"
4. åˆå¹¶æˆåŠŸæ›´æ–°ä¸º"completed"
5. åˆå¹¶å¤±è´¥æ›´æ–°ä¸º"failed"
6. å®šæ—¶ä»»åŠ¡æ¸…ç†ï¼š
   - æ•°æ®åº“ä¸­"uploading"è¶…è¿‡ 24 å°æ—¶çš„è®°å½•
   - æ–‡ä»¶ç³»ç»Ÿä¸­è¶…è¿‡ 24 å°æ—¶çš„åˆ†å—ç›®å½•

**ä¼˜ç‚¹**ï¼š

- å…¼é¡¾å¯è¿½è¸ªæ€§å’Œç®€æ´æ€§
- åŒé‡ä¿é™©ï¼ˆæ•°æ®åº“+æ–‡ä»¶ç³»ç»Ÿï¼‰
- æœ‰å®Œæ•´çš„å®¡è®¡è®°å½•

### 2.2 æ¨èæ–¹æ¡ˆå®æ–½

æˆ‘å»ºè®®ä½¿ç”¨**æ–¹æ¡ˆ 2ï¼ˆåŸºäºæ–‡ä»¶æ—¶é—´æˆ³ï¼‰**ï¼Œå› ä¸ºï¼š

1. å®ç°æœ€ç®€å•
2. ä¸éœ€è¦ä¿®æ”¹ç°æœ‰æµç¨‹
3. å¯¹äºå­¦ä¹ é¡¹ç›®æ¥è¯´è¶³å¤Ÿäº†

---

## ä¸‰ã€æ–¹æ¡ˆ 2 å®ç°ï¼šåŸºäºæ–‡ä»¶æ—¶é—´æˆ³çš„æ¸…ç†

### 3.1 åˆ›å»ºå®šæ—¶æ¸…ç†ä»»åŠ¡

**æ–‡ä»¶ä½ç½®**ï¼š`xuecheng-plus-media/xuecheng-plus-media-service/src/main/java/com/xuecheng/media/task/ChunkCleanupTask.java`

```java
package com.xuecheng.media.task;

import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.nio.file.DirectoryStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.BasicFileAttributes;
import java.time.Instant;
import java.time.temporal.ChronoUnit;

/**
 * åˆ†å—æ–‡ä»¶æ¸…ç†å®šæ—¶ä»»åŠ¡
 *
 * ğŸ¯ åŠŸèƒ½è¯´æ˜ï¼š
 * å®šæœŸæ¸…ç†è¶…è¿‡æŒ‡å®šæ—¶é—´çš„ä¸´æ—¶åˆ†å—æ–‡ä»¶ï¼Œé˜²æ­¢ç£ç›˜ç©ºé—´æµªè´¹
 *
 * ğŸ“Š æ¸…ç†ç­–ç•¥ï¼š
 * 1. æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œä¸€æ¬¡
 * 2. æ‰«æä¸´æ—¶åˆ†å—ç›®å½•ï¼ˆ/tmp/xc-chunks/ï¼‰
 * 3. æ£€æŸ¥æ¯ä¸ªåˆ†å—ç›®å½•çš„æœ€åä¿®æ”¹æ—¶é—´
 * 4. åˆ é™¤è¶…è¿‡24å°æ—¶çš„åˆ†å—ç›®å½•
 *
 * ğŸ” åˆ¤æ–­é€»è¾‘ï¼š
 * - æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ–‡ä»¶ä¸Šä¼ åœ¨å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶å†…å®Œæˆ
 * - è¶…è¿‡24å°æ—¶çš„åˆ†å—ç›®å½•ï¼Œå¿…å®šæ˜¯ä¸­æ–­/å¤±è´¥çš„ä¸Šä¼ 
 * - å®‰å…¨åˆ é™¤ï¼Œä¸ä¼šå½±å“æ­£åœ¨è¿›è¡Œçš„ä¸Šä¼ 
 *
 * âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
 * - æ—¶é—´é˜ˆå€¼å¯é…ç½®ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
 * - åˆ é™¤å‰ä¼šè®°å½•è¯¦ç»†æ—¥å¿—
 * - åˆ é™¤å¤±è´¥ä¸å½±å“ä»»åŠ¡ç»§ç»­æ‰§è¡Œ
 *
 * @author AI Assistant
 * @version 1.0
 * @date 2025-10-07
 */
@Slf4j
@Component
public class ChunkCleanupTask {

    /**
     * åˆ†å—æ–‡ä»¶æ ¹ç›®å½•
     */
    private static final String CHUNK_ROOT = System.getProperty("java.io.tmpdir") + "/xc-chunks";

    /**
     * æ¸…ç†é˜ˆå€¼ï¼ˆå°æ—¶ï¼‰
     */
    private static final int CLEANUP_THRESHOLD_HOURS = 24;

    /**
     * å®šæ—¶æ¸…ç†ä»»åŠ¡
     *
     * cronè¡¨è¾¾å¼ï¼š0 0 2 * * ?
     * - ç§’ï¼š0
     * - åˆ†ï¼š0
     * - æ—¶ï¼š2ï¼ˆå‡Œæ™¨2ç‚¹ï¼‰
     * - æ—¥ï¼š*ï¼ˆæ¯å¤©ï¼‰
     * - æœˆï¼š*ï¼ˆæ¯æœˆï¼‰
     * - æ˜ŸæœŸï¼š?ï¼ˆä¸æŒ‡å®šï¼‰
     *
     * æ‰§è¡Œæ—¶é—´ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanupOldChunks() {
        log.info("========== å¼€å§‹æ‰§è¡Œåˆ†å—æ–‡ä»¶æ¸…ç†ä»»åŠ¡ ==========");

        Path rootPath = Paths.get(CHUNK_ROOT);

        // æ£€æŸ¥æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
        if (!Files.exists(rootPath)) {
            log.info("åˆ†å—æ ¹ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç†ï¼š{}", CHUNK_ROOT);
            return;
        }

        int totalDirs = 0;      // æ€»ç›®å½•æ•°
        int deletedDirs = 0;    // åˆ é™¤çš„ç›®å½•æ•°
        long freedSpace = 0;    // é‡Šæ”¾çš„ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰

        try (DirectoryStream<Path> stream = Files.newDirectoryStream(rootPath)) {
            for (Path chunkDir : stream) {
                // åªå¤„ç†ç›®å½•
                if (!Files.isDirectory(chunkDir)) {
                    continue;
                }

                totalDirs++;

                try {
                    // è·å–ç›®å½•çš„æœ€åä¿®æ”¹æ—¶é—´
                    BasicFileAttributes attrs = Files.readAttributes(chunkDir, BasicFileAttributes.class);
                    Instant lastModified = attrs.lastModifiedTime().toInstant();
                    Instant threshold = Instant.now().minus(CLEANUP_THRESHOLD_HOURS, ChronoUnit.HOURS);

                    // åˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼
                    if (lastModified.isBefore(threshold)) {
                        // è®¡ç®—ç›®å½•å¤§å°
                        long dirSize = calculateDirSize(chunkDir);

                        // åˆ é™¤ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹
                        deleteDirectory(chunkDir);

                        deletedDirs++;
                        freedSpace += dirSize;

                        log.info("âœ… æ¸…ç†è¿‡æœŸåˆ†å—ç›®å½•ï¼š{}ï¼Œå¤§å°ï¼š{}MBï¼Œæœ€åä¿®æ”¹æ—¶é—´ï¼š{}",
                                chunkDir.getFileName(),
                                dirSize / 1024 / 1024,
                                lastModified);
                    } else {
                        log.debug("åˆ†å—ç›®å½•æœªè¿‡æœŸï¼Œè·³è¿‡ï¼š{}ï¼Œæœ€åä¿®æ”¹æ—¶é—´ï¼š{}",
                                chunkDir.getFileName(), lastModified);
                    }

                } catch (Exception e) {
                    log.error("å¤„ç†åˆ†å—ç›®å½•å¤±è´¥ï¼š{}ï¼Œé”™è¯¯ï¼š{}", chunkDir, e.getMessage(), e);
                    // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªç›®å½•
                }
            }
        } catch (IOException e) {
            log.error("æ‰«æåˆ†å—æ ¹ç›®å½•å¤±è´¥ï¼š{}", e.getMessage(), e);
        }

        log.info("========== åˆ†å—æ–‡ä»¶æ¸…ç†ä»»åŠ¡å®Œæˆ ==========");
        log.info("æ‰«æç›®å½•æ•°ï¼š{}ï¼Œæ¸…ç†ç›®å½•æ•°ï¼š{}ï¼Œé‡Šæ”¾ç©ºé—´ï¼š{}MB",
                totalDirs, deletedDirs, freedSpace / 1024 / 1024);
    }

    /**
     * è®¡ç®—ç›®å½•å¤§å°
     */
    private long calculateDirSize(Path dir) {
        long size = 0;
        try (DirectoryStream<Path> stream = Files.newDirectoryStream(dir)) {
            for (Path file : stream) {
                if (Files.isRegularFile(file)) {
                    size += Files.size(file);
                }
            }
        } catch (IOException e) {
            log.warn("è®¡ç®—ç›®å½•å¤§å°å¤±è´¥ï¼š{}", dir, e);
        }
        return size;
    }

    /**
     * é€’å½’åˆ é™¤ç›®å½•
     */
    private void deleteDirectory(Path dir) throws IOException {
        // å…ˆåˆ é™¤ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        try (DirectoryStream<Path> stream = Files.newDirectoryStream(dir)) {
            for (Path file : stream) {
                if (Files.isDirectory(file)) {
                    // é€’å½’åˆ é™¤å­ç›®å½•
                    deleteDirectory(file);
                } else {
                    // åˆ é™¤æ–‡ä»¶
                    Files.deleteIfExists(file);
                }
            }
        }
        // æœ€ååˆ é™¤ç©ºç›®å½•
        Files.deleteIfExists(dir);
    }

    /**
     * æ‰‹åŠ¨è§¦å‘æ¸…ç†ï¼ˆç”¨äºæµ‹è¯•ï¼‰
     *
     * å¯ä»¥é€šè¿‡JMXæˆ–HTTPæ¥å£è°ƒç”¨æ­¤æ–¹æ³•è¿›è¡Œæ‰‹åŠ¨æ¸…ç†
     */
    public void manualCleanup() {
        log.info("æ‰‹åŠ¨è§¦å‘åˆ†å—æ–‡ä»¶æ¸…ç†ä»»åŠ¡");
        cleanupOldChunks();
    }
}
```

### 3.2 å¯ç”¨å®šæ—¶ä»»åŠ¡

**æ–‡ä»¶ä½ç½®**ï¼š`xuecheng-plus-media/xuecheng-plus-media-api/src/main/java/com/xuecheng/MediaApplication.java`

åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  `@EnableScheduling` æ³¨è§£ï¼š

```java
package com.xuecheng;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@EnableScheduling  // å¯ç”¨å®šæ—¶ä»»åŠ¡
public class MediaApplication {
    public static void main(String[] args) {
        SpringApplication.run(MediaApplication.class, args);
    }
}
```

### 3.3 é…ç½®æ¸…ç†å‚æ•°ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`nacos-config-media-service-dev.yaml`ï¼ˆNacos é…ç½®ï¼‰

```yaml
# åˆ†å—æ–‡ä»¶æ¸…ç†é…ç½®
chunk:
  cleanup:
    enabled: true # æ˜¯å¦å¯ç”¨æ¸…ç†ä»»åŠ¡
    cron: "0 0 2 * * ?" # æ‰§è¡Œæ—¶é—´ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
    threshold-hours: 24 # æ¸…ç†é˜ˆå€¼ï¼ˆå°æ—¶ï¼‰
```

---

## å››ã€å¢å¼ºç‰ˆæ¸…ç†æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ 3ï¼‰

å¦‚æœä½ æƒ³è¦æ›´å®Œå–„çš„æ–¹æ¡ˆï¼Œå¯ä»¥ç»“åˆæ•°æ®åº“çŠ¶æ€ï¼š

### 4.1 æ•°æ®åº“è¡¨å¢å¼º

**æ·»åŠ  upload_status å­—æ®µ**ï¼ˆå¯é€‰ï¼‰ï¼š

```sql
-- ä¸º media_files è¡¨æ·»åŠ ä¸Šä¼ çŠ¶æ€å­—æ®µ
ALTER TABLE media_files
ADD COLUMN upload_status VARCHAR(20) DEFAULT 'completed' COMMENT 'ä¸Šä¼ çŠ¶æ€ï¼šuploading-ä¸Šä¼ ä¸­ï¼Œcompleted-å·²å®Œæˆï¼Œfailed-å¤±è´¥';

-- æ·»åŠ ç´¢å¼•ï¼Œä¾¿äºå®šæ—¶ä»»åŠ¡æŸ¥è¯¢
CREATE INDEX idx_upload_status_time
ON media_files(upload_status, create_date);
```

### 4.2 ä¿®æ”¹åˆå¹¶æµç¨‹

åœ¨ `MediaFileServiceImpl.java` çš„ `mergechunks` æ–¹æ³•ä¸­ï¼š

```java
@Override
public RestResponse mergechunks(Long companyId, String fileMd5, int chunkTotal,
        UploadFileParamsDto uploadFileParamsDto) {

    // ===== æ­¥éª¤1ï¼šåˆ›å»º"ä¸Šä¼ ä¸­"è®°å½• =====
    MediaFiles uploadingRecord = new MediaFiles();
    uploadingRecord.setId(fileMd5);
    uploadingRecord.setCompanyId(companyId);
    uploadingRecord.setFilename(uploadFileParamsDto.getFilename());
    uploadingRecord.setUploadStatus("uploading");  // æ ‡è®°ä¸ºä¸Šä¼ ä¸­
    uploadingRecord.setCreateDate(LocalDateTime.now());

    try {
        // å°è¯•æ’å…¥"ä¸Šä¼ ä¸­"è®°å½•
        mediaFilesMapper.insert(uploadingRecord);
    } catch (Exception e) {
        // å¦‚æœè®°å½•å·²å­˜åœ¨ï¼Œæ›´æ–°çŠ¶æ€ä¸º"uploading"
        uploadingRecord.setUploadStatus("uploading");
        mediaFilesMapper.updateById(uploadingRecord);
    }

    try {
        // ===== æ­¥éª¤2-5ï¼šåŸæœ‰çš„åˆå¹¶é€»è¾‘ =====
        // ... æ£€æŸ¥åˆ†å—ã€åˆå¹¶ã€MD5æ ¡éªŒã€ä¸Šä¼ OSSã€å…¥åº“ ...

        // ===== æ­¥éª¤6ï¼šæ›´æ–°çŠ¶æ€ä¸º"å·²å®Œæˆ" =====
        mediaFiles.setUploadStatus("completed");
        mediaFilesMapper.updateById(mediaFiles);

        // ===== æ­¥éª¤7ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶ =====
        // ... æ¸…ç†åˆ†å— ...

        return RestResponse.success(true);

    } catch (Exception e) {
        // ===== åˆå¹¶å¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€ä¸º"å¤±è´¥" =====
        uploadingRecord.setUploadStatus("failed");
        uploadingRecord.setRemark("åˆå¹¶å¤±è´¥ï¼š" + e.getMessage());
        mediaFilesMapper.updateById(uploadingRecord);

        log.error("åˆå¹¶æ–‡ä»¶å¼‚å¸¸ï¼ŒMD5ï¼š{}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š{}", fileMd5, e.getMessage(), e);
        return RestResponse.validfail(false, "åˆå¹¶æ–‡ä»¶å¼‚å¸¸ï¼š" + e.getMessage());
    }
}
```

### 4.3 å¢å¼ºç‰ˆæ¸…ç†ä»»åŠ¡

```java
@Scheduled(cron = "0 0 2 * * ?")
public void cleanupOldChunks() {
    log.info("========== å¼€å§‹æ‰§è¡Œåˆ†å—æ–‡ä»¶æ¸…ç†ä»»åŠ¡ ==========");

    // ===== æ¸…ç†1ï¼šåŸºäºæ•°æ®åº“çŠ¶æ€çš„æ¸…ç† =====
    cleanupByDatabaseStatus();

    // ===== æ¸…ç†2ï¼šåŸºäºæ–‡ä»¶æ—¶é—´æˆ³çš„æ¸…ç†ï¼ˆå…œåº•ï¼‰ =====
    cleanupByFileTimestamp();

    log.info("========== åˆ†å—æ–‡ä»¶æ¸…ç†ä»»åŠ¡å®Œæˆ ==========");
}

/**
 * åŸºäºæ•°æ®åº“çŠ¶æ€çš„æ¸…ç†
 */
private void cleanupByDatabaseStatus() {
    // æŸ¥è¯¢"ä¸Šä¼ ä¸­"ä¸”è¶…è¿‡24å°æ—¶çš„è®°å½•
    LocalDateTime threshold = LocalDateTime.now().minusHours(24);
    LambdaQueryWrapper<MediaFiles> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(MediaFiles::getUploadStatus, "uploading")
           .lt(MediaFiles::getCreateDate, threshold);

    List<MediaFiles> oldUploads = mediaFilesMapper.selectList(wrapper);

    for (MediaFiles file : oldUploads) {
        try {
            // åˆ é™¤åˆ†å—æ–‡ä»¶
            Path chunkDir = getChunkRootPath(file.getId());
            if (Files.exists(chunkDir)) {
                deleteDirectory(chunkDir);
                log.info("âœ… æ¸…ç†æ•°æ®åº“å…³è”çš„åˆ†å—ï¼šMD5={}ï¼Œæ–‡ä»¶åï¼š{}",
                        file.getId(), file.getFilename());
            }

            // åˆ é™¤æ•°æ®åº“è®°å½•
            mediaFilesMapper.deleteById(file.getId());

        } catch (Exception e) {
            log.error("æ¸…ç†å¤±è´¥ï¼šMD5={}", file.getId(), e);
        }
    }
}

/**
 * åŸºäºæ–‡ä»¶æ—¶é—´æˆ³çš„æ¸…ç†ï¼ˆå…œåº•ï¼‰
 */
private void cleanupByFileTimestamp() {
    // ... æ–¹æ¡ˆ2çš„å®ç° ...
}
```

---

## äº”ã€å½“å‰é¡¹ç›®çš„æœ€ä½³å®è·µ

åŸºäºä½ çš„é¡¹ç›®æƒ…å†µï¼Œæˆ‘å»ºè®®é‡‡ç”¨**ç®€åŒ–ç‰ˆçš„æ–¹æ¡ˆ 2**ï¼š

### 5.1 å®æ–½æ­¥éª¤

#### Step 1: åˆ›å»ºæ¸…ç†ä»»åŠ¡ç±»

å°†ä¸Šé¢çš„ `ChunkCleanupTask.java` åˆ›å»ºåˆ°ï¼š

```
xuecheng-plus-media/xuecheng-plus-media-service/src/main/java/com/xuecheng/media/task/
```

#### Step 2: å¯ç”¨å®šæ—¶ä»»åŠ¡

åœ¨ `MediaApplication.java` ä¸Šæ·»åŠ  `@EnableScheduling`

#### Step 3: é…ç½®æ¸…ç†å‚æ•°ï¼ˆå¯é€‰ï¼‰

åœ¨ Nacos é…ç½®ä¸­æ·»åŠ ï¼š

```yaml
chunk:
  cleanup:
    enabled: true
    cron: "0 0 2 * * ?" # æ¯å¤©å‡Œæ™¨2ç‚¹
    threshold-hours: 24
```

#### Step 4: æµ‹è¯•æ¸…ç†ä»»åŠ¡

```java
// æ·»åŠ æµ‹è¯•æ¥å£ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
@RestController
@RequestMapping("/test")
public class TestController {
    @Autowired
    private ChunkCleanupTask cleanupTask;

    @GetMapping("/cleanup-chunks")
    public String testCleanup() {
        cleanupTask.manualCleanup();
        return "æ¸…ç†ä»»åŠ¡å·²æ‰§è¡Œ";
    }
}
```

---

## å…­ã€å…¶ä»–ä¼˜åŒ–å»ºè®®

### 6.1 åˆå¹¶æˆåŠŸåç«‹å³æ¸…ç†

**å½“å‰å®ç°**ï¼ˆå·²æœ‰ï¼‰ï¼š

```java
// åˆå¹¶æˆåŠŸåæ¸…ç†
for (int i = 0; i < chunkTotal; i++) {
    Files.deleteIfExists(chunkRoot.resolve(String.valueOf(i)));
}
Files.deleteIfExists(chunkRoot);
```

âœ… è¿™ä¸ªå·²ç»åšå¾—å¾ˆå¥½äº†

### 6.2 åˆå¹¶å¤±è´¥åä¹Ÿæ¸…ç†

**ä¼˜åŒ–å»ºè®®**ï¼š

```java
} catch (Exception e) {
    // è®°å½•å¼‚å¸¸
    log.error("åˆå¹¶æ–‡ä»¶å¼‚å¸¸ï¼ŒMD5ï¼š{}", fileMd5, e);

    // æ¸…ç†å·²åˆå¹¶çš„ä¸´æ—¶æ–‡ä»¶
    try {
        if (merged != null && Files.exists(merged)) {
            Files.deleteIfExists(merged);
        }
    } catch (Exception cleanEx) {
        log.warn("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥", cleanEx);
    }

    // æ³¨æ„ï¼šåˆ†å—æ–‡ä»¶ä¸åˆ é™¤ï¼Œä¾¿äºç”¨æˆ·é‡è¯•

    return RestResponse.validfail(false, "åˆå¹¶æ–‡ä»¶å¼‚å¸¸ï¼š" + e.getMessage());
}
```

### 6.3 å¢åŠ åˆ†å—ç›®å½•å¤§å°é™åˆ¶

é˜²æ­¢æ¶æ„ä¸Šä¼ å æ»¡ç£ç›˜ï¼š

```java
@Override
public RestResponse uploadChunk(String fileMd5, int chunk, String localChunkFilePath) {
    try {
        Path root = getChunkRootPath(fileMd5);

        // æ£€æŸ¥å½“å‰åˆ†å—ç›®å½•çš„æ€»å¤§å°
        long currentSize = calculateDirSize(root);
        long maxSize = 5L * 1024 * 1024 * 1024;  // å•ä¸ªæ–‡ä»¶æœ€å¤§5GB

        if (currentSize > maxSize) {
            log.error("åˆ†å—ç›®å½•è¶…è¿‡æœ€å¤§é™åˆ¶ï¼š{}MB", currentSize / 1024 / 1024);
            return RestResponse.validfail(false, "æ–‡ä»¶è¿‡å¤§ï¼Œè¶…è¿‡5GBé™åˆ¶");
        }

        // ... åŸæœ‰çš„ä¸Šä¼ é€»è¾‘ ...
    }
}
```

---

## ä¸ƒã€ç›‘æ§ä¸å‘Šè­¦

### 7.1 æ·»åŠ ç›‘æ§æŒ‡æ ‡

```java
@Component
public class ChunkMetrics {

    private final AtomicLong totalChunkDirs = new AtomicLong(0);
    private final AtomicLong totalChunkSize = new AtomicLong(0);

    /**
     * å®šæ—¶ç»Ÿè®¡åˆ†å—æ–‡ä»¶æƒ…å†µ
     */
    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡
    public void collectMetrics() {
        Path rootPath = Paths.get(CHUNK_ROOT);
        if (!Files.exists(rootPath)) {
            return;
        }

        long dirCount = 0;
        long totalSize = 0;

        try (DirectoryStream<Path> stream = Files.newDirectoryStream(rootPath)) {
            for (Path dir : stream) {
                if (Files.isDirectory(dir)) {
                    dirCount++;
                    totalSize += calculateDirSize(dir);
                }
            }
        } catch (IOException e) {
            log.error("ç»Ÿè®¡åˆ†å—æ–‡ä»¶å¤±è´¥", e);
        }

        totalChunkDirs.set(dirCount);
        totalChunkSize.set(totalSize);

        // å‘Šè­¦ï¼šå¦‚æœåˆ†å—ç›®å½•è¶…è¿‡100ä¸ª
        if (dirCount > 100) {
            log.warn("âš ï¸ åˆ†å—ç›®å½•æ•°é‡è¿‡å¤šï¼š{}ä¸ªï¼Œå»ºè®®æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡æœªå®Œæˆçš„ä¸Šä¼ ", dirCount);
        }

        // å‘Šè­¦ï¼šå¦‚æœæ€»å¤§å°è¶…è¿‡10GB
        if (totalSize > 10L * 1024 * 1024 * 1024) {
            log.warn("âš ï¸ åˆ†å—æ–‡ä»¶å ç”¨ç©ºé—´è¿‡å¤§ï¼š{}GBï¼Œå»ºè®®æ‰§è¡Œæ¸…ç†ä»»åŠ¡",
                    totalSize / 1024 / 1024 / 1024);
        }
    }

    // æä¾›æ¥å£æŸ¥è¯¢å½“å‰çŠ¶æ€
    public long getChunkDirCount() {
        return totalChunkDirs.get();
    }

    public long getChunkTotalSize() {
        return totalChunkSize.get();
    }
}
```

### 7.2 æš´éœ²ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/admin/chunk")
public class ChunkManagementController {

    @Autowired
    private ChunkCleanupTask cleanupTask;

    @Autowired
    private ChunkMetrics chunkMetrics;

    /**
     * æŸ¥è¯¢å½“å‰åˆ†å—æ–‡ä»¶çŠ¶æ€
     */
    @GetMapping("/status")
    public Map<String, Object> getStatus() {
        Map<String, Object> result = new HashMap<>();
        result.put("dirCount", chunkMetrics.getChunkDirCount());
        result.put("totalSize", chunkMetrics.getChunkTotalSize());
        result.put("totalSizeMB", chunkMetrics.getChunkTotalSize() / 1024 / 1024);
        return result;
    }

    /**
     * æ‰‹åŠ¨è§¦å‘æ¸…ç†
     */
    @PostMapping("/cleanup")
    public String manualCleanup() {
        cleanupTask.manualCleanup();
        return "æ¸…ç†ä»»åŠ¡å·²æ‰§è¡Œ";
    }
}
```

---

## å…«ã€æ¸…ç†ä»»åŠ¡çš„æœ€ä½³å®è·µ

### 8.1 æ¸…ç†æ—¶æœºé€‰æ‹©

| æ—¶æœº          | Cron è¡¨è¾¾å¼     | è¯´æ˜                   | æ¨è        |
| ------------- | --------------- | ---------------------- | ----------- |
| æ¯å¤©å‡Œæ™¨ 2 ç‚¹ | `0 0 2 * * ?`   | ç”¨æˆ·ä½¿ç”¨æœ€å°‘çš„æ—¶æ®µ     | âœ… æ¨è     |
| æ¯ 6 å°æ—¶     | `0 0 */6 * * ?` | æ›´é¢‘ç¹ï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½ | âš ï¸ é«˜é¢‘åœºæ™¯ |
| æ¯å‘¨æ—¥å‡Œæ™¨    | `0 0 2 ? * SUN` | é¢‘ç‡è¾ƒä½               | âŒ ä¸æ¨è   |

### 8.2 æ¸…ç†é˜ˆå€¼é€‰æ‹©

| é˜ˆå€¼    | é€‚ç”¨åœºæ™¯   | é£é™©                         |
| ------- | ---------- | ---------------------------- |
| 1 å°æ—¶  | æµ‹è¯•ç¯å¢ƒ   | âš ï¸ å¯èƒ½è¯¯åˆ æ­£åœ¨ä¸Šä¼ çš„å¤§æ–‡ä»¶  |
| 6 å°æ—¶  | å°æ–‡ä»¶åœºæ™¯ | âš ï¸ å¤§æ–‡ä»¶ä¸Šä¼ å¯èƒ½è¶…è¿‡ 6 å°æ—¶ |
| 24 å°æ—¶ | ä¸€èˆ¬åœºæ™¯   | âœ… å¹³è¡¡å®‰å…¨æ€§å’ŒåŠæ—¶æ€§        |
| 72 å°æ—¶ | è°¨æ…æ¸…ç†   | âŒ åƒåœ¾æ–‡ä»¶ç§¯ç´¯æ—¶é—´é•¿        |

**æ¨è**ï¼š24 å°æ—¶ï¼ˆé»˜è®¤ï¼‰

### 8.3 æ¸…ç†ç­–ç•¥

**ç­–ç•¥ 1ï¼šä¿å®ˆæ¸…ç†**

- åªåˆ é™¤ç¡®å®šä¸ä¼šå†ç”¨çš„æ–‡ä»¶
- æ¸…ç†é˜ˆå€¼è¾ƒé•¿ï¼ˆ48-72 å°æ—¶ï¼‰
- é€‚åˆå­˜å‚¨ç©ºé—´å……è¶³çš„åœºæ™¯

**ç­–ç•¥ 2ï¼šæ¿€è¿›æ¸…ç†**

- åŠæ—¶æ¸…ç†å¯èƒ½çš„åƒåœ¾æ–‡ä»¶
- æ¸…ç†é˜ˆå€¼è¾ƒçŸ­ï¼ˆ6-12 å°æ—¶ï¼‰
- é€‚åˆå­˜å‚¨ç©ºé—´ç´§å¼ çš„åœºæ™¯

**ç­–ç•¥ 3ï¼šæ™ºèƒ½æ¸…ç†ï¼ˆæ¨èï¼‰**

- ç»“åˆæ•°æ®åº“çŠ¶æ€å’Œæ–‡ä»¶æ—¶é—´æˆ³
- å¯¹"å·²å®Œæˆ"çš„æ–‡ä»¶ï¼Œç«‹å³æ¸…ç†åˆ†å—
- å¯¹"ä¸Šä¼ ä¸­"çš„æ–‡ä»¶ï¼Œ24 å°æ—¶åæ¸…ç†
- å¯¹æ— è®°å½•çš„æ–‡ä»¶ï¼Œ24 å°æ—¶åæ¸…ç†

---

## ä¹ã€å®æ–½å»ºè®®

### å¯¹äºä½ çš„é¡¹ç›®

è€ƒè™‘åˆ°ä½ çš„é¡¹ç›®æ˜¯å­¦ä¹ é¡¹ç›®ï¼Œæˆ‘å»ºè®®ï¼š

1. **ç°é˜¶æ®µï¼ˆæ¨èï¼‰**ï¼š

   - å®æ–½ç®€å•çš„åŸºäºæ—¶é—´æˆ³çš„æ¸…ç†ï¼ˆæ–¹æ¡ˆ 2ï¼‰
   - æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
   - 24 å°æ—¶é˜ˆå€¼
   - ä¸ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„

2. **è¿›é˜¶é˜¶æ®µ**ï¼ˆå¯é€‰ï¼‰ï¼š

   - æ·»åŠ  `upload_status` å­—æ®µ
   - å®æ–½æ··åˆæ¸…ç†æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ 3ï¼‰
   - å¢åŠ ç›‘æ§å’Œå‘Šè­¦

3. **ç”Ÿäº§ç¯å¢ƒ**ï¼ˆæœªæ¥ï¼‰ï¼š
   - ä½¿ç”¨åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ XXL-JOBï¼‰
   - å¢åŠ æ¸…ç†ä»»åŠ¡çš„å¹‚ç­‰æ€§ä¿è¯
   - é›†æˆç›‘æ§ç³»ç»Ÿï¼ˆPrometheus + Grafanaï¼‰
   - è®¾ç½®å‘Šè­¦è§„åˆ™

---

## åã€æ€»ç»“

### è§†é¢‘æ ¸å¿ƒè¦ç‚¹

1. **æ–­ç‚¹ç»­ä¼ åŸç†**ï¼š

   - å‰ç«¯åˆ†å—ä¸Šä¼ 
   - æ¯å—ä¸Šä¼ å‰å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
   - å·²å­˜åœ¨çš„å—ä¸é‡å¤ä¸Šä¼ 
   - æ‰€æœ‰å—ä¸Šä¼ å®Œæˆååˆå¹¶

2. **åˆ†å—æ–‡ä»¶æ¸…ç†**ï¼š
   - é—®é¢˜ï¼šä¸Šä¼ å¤±è´¥çš„åˆ†å—ä¼šå ç”¨ç©ºé—´
   - è§£å†³ï¼šå®šæ—¶ä»»åŠ¡æ‰«æå¹¶æ¸…ç†è¿‡æœŸæ–‡ä»¶
   - åˆ¤æ–­ï¼šåŸºäºæ—¶é—´æˆ³æˆ–æ•°æ®åº“çŠ¶æ€

### ä½ çš„é¡¹ç›®ç°çŠ¶

âœ… **å·²å®ç°**ï¼š

- å®Œæ•´çš„åˆ†å—ä¸Šä¼ æµç¨‹
- MD5 æ ¡éªŒæœºåˆ¶
- åˆå¹¶æˆåŠŸåçš„ç«‹å³æ¸…ç†

âŒ **å¾…ä¼˜åŒ–**ï¼š

- å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆé˜²æ­¢åƒåœ¾æ–‡ä»¶ç§¯ç´¯ï¼‰

### æ¨èå®æ–½æ­¥éª¤

1. **ç«‹å³å®æ–½**ï¼šåˆ›å»º `ChunkCleanupTask` å®šæ—¶ä»»åŠ¡
2. **ä¸‹æ¬¡ä¼˜åŒ–**ï¼šæ·»åŠ  `upload_status` å­—æ®µ
3. **ç”Ÿäº§ä¸Šçº¿å‰**ï¼šæ·»åŠ ç›‘æ§å’Œå‘Šè­¦

---

## åä¸€ã€ç›¸å…³æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

- `xuecheng-plus-media-service/src/main/java/com/xuecheng/media/task/ChunkCleanupTask.java`

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

- `xuecheng-plus-media-api/src/main/java/com/xuecheng/MediaApplication.java` - æ·»åŠ  `@EnableScheduling`

### å¯é€‰ä¼˜åŒ–

- `media_files` è¡¨ - æ·»åŠ  `upload_status` å­—æ®µ
- `MediaFileServiceImpl.java` - å¢å¼ºåˆå¹¶æµç¨‹çš„çŠ¶æ€ç®¡ç†

---

**è¦æˆ‘ç°åœ¨ä¸ºä½ åˆ›å»ºè¿™ä¸ªæ¸…ç†ä»»åŠ¡å—ï¼Ÿè¿˜æ˜¯å…ˆæŠŠè§†é¢‘ä¸Šä¼ çš„ä¸»æµç¨‹å®Œå…¨è·‘é€šå†è¯´ï¼Ÿ**
