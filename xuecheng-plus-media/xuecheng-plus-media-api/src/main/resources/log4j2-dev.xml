<?xml version="1.0" encoding="UTF-8"?>
<Configuration monitorInterval="180" packages="">
    <properties>
        <!-- 日志目录：项目根目录的logs文件夹 -->
        <property name="logdir">D:/project/java/xuecheng-plus-project/logs</property>
        <property name="serviceName">media-api</property>

        <!-- 文件日志格式（增强版）：包含requestId、userId、IP等追踪信息 -->
        <property name="FILE_PATTERN">%d{yyyy-MM-dd HH:mm:ss.SSS} | %-5level | [%X{requestId}] |
            [%X{userId}] | [%X{ip}] | [%thread] | %logger{50}.%M(%F:%line) | %msg%n%throwable</property>

        <!-- 控制台日志格式：彩色+简洁+requestId -->
        <property name="CONSOLE_PATTERN">%d{HH:mm:ss.SSS} %highlight{%-5level}{ERROR=Bright Red,
            WARN=Bright Yellow, INFO=Bright Green, DEBUG=Bright Cyan}
            %style{[%X{requestId}]}{Magenta} %style{[%t]}{Bright Blue} %style{%logger{40}.%M}{Cyan}
            : %msg%n%throwable</property>

        <!-- SQL日志格式：专门用于SQL记录 -->
        <property name="SQL_PATTERN">%d{yyyy-MM-dd HH:mm:ss.SSS} | [%X{requestId}] | %msg%n</property>
    </properties>

    <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${CONSOLE_PATTERN}" />
        </Console>

        <!-- ========== 错误日志（ERROR级别） ========== -->
        <RollingFile name="ErrorAppender"
            fileName="${logdir}/${serviceName}-error.log"
            filePattern="${logdir}/$${date:yyyy-MM-dd}/${serviceName}-error.%d{yyyy-MM-dd-HH}.log">
            <PatternLayout pattern="${FILE_PATTERN}" />
            <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY" />
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="100MB" />
            </Policies>
            <DefaultRolloverStrategy max="30" />
        </RollingFile>

        <!-- ========== 警告日志（WARN级别） ========== -->
        <RollingFile name="WarnAppender"
            fileName="${logdir}/${serviceName}-warn.log"
            filePattern="${logdir}/$${date:yyyy-MM-dd}/${serviceName}-warn.%d{yyyy-MM-dd-HH}.log">
            <PatternLayout pattern="${FILE_PATTERN}" />
            <ThresholdFilter level="WARN" onMatch="ACCEPT" onMismatch="DENY" />
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="100MB" />
            </Policies>
            <DefaultRolloverStrategy max="30" />
        </RollingFile>

        <!-- ========== 信息日志（INFO级别） ========== -->
        <RollingFile name="InfoAppender"
            fileName="${logdir}/${serviceName}-info.log"
            filePattern="${logdir}/$${date:yyyy-MM-dd}/${serviceName}-info.%d{yyyy-MM-dd-HH}.log">
            <PatternLayout pattern="${FILE_PATTERN}" />
            <ThresholdFilter level="INFO" onMatch="ACCEPT" onMismatch="DENY" />
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="100MB" />
            </Policies>
            <DefaultRolloverStrategy max="30" />
        </RollingFile>

        <!-- ========== 调试日志（DEBUG级别） ========== -->
        <RollingFile name="DebugAppender"
            fileName="${logdir}/${serviceName}-debug.log"
            filePattern="${logdir}/$${date:yyyy-MM-dd}/${serviceName}-debug.%d{yyyy-MM-dd-HH}.log">
            <PatternLayout pattern="${FILE_PATTERN}" />
            <ThresholdFilter level="DEBUG" onMatch="ACCEPT" onMismatch="DENY" />
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="200MB" />
            </Policies>
            <DefaultRolloverStrategy max="7" />
        </RollingFile>

        <!-- ========== SQL日志（专门记录数据库操作） ========== -->
        <RollingFile name="SqlAppender"
            fileName="${logdir}/${serviceName}-sql.log"
            filePattern="${logdir}/$${date:yyyy-MM-dd}/${serviceName}-sql.%d{yyyy-MM-dd-HH}.log">
            <PatternLayout pattern="${SQL_PATTERN}" />
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="200MB" />
            </Policies>
            <DefaultRolloverStrategy max="7" />
        </RollingFile>

        <!-- ========== 异步Appender（提升性能） ========== -->
        <Async name="AsyncAppender" bufferSize="1024" includeLocation="true">
            <AppenderRef ref="ErrorAppender" />
            <AppenderRef ref="WarnAppender" />
            <AppenderRef ref="InfoAppender" />
            <AppenderRef ref="DebugAppender" />
        </Async>
    </Appenders>

    <Loggers>
        <!-- ========== MyBatis SQL日志（详细记录） ========== -->
        <logger name="com.xuecheng.media.mapper" level="DEBUG" additivity="false">
            <AppenderRef ref="SqlAppender" />
            <AppenderRef ref="Console" />
        </logger>

        <!-- MyBatis内部日志 -->
        <logger name="org.apache.ibatis" level="DEBUG" additivity="false">
            <AppenderRef ref="SqlAppender" />
        </logger>

        <!-- Druid数据源SQL日志 -->
        <logger name="druid.sql.Statement" level="DEBUG" additivity="false">
            <AppenderRef ref="SqlAppender" />
        </logger>

        <!-- ========== 第三方框架日志（减少噪音） ========== -->
        <logger name="org.springframework" level="WARN" />
        <logger name="org.mybatis" level="WARN" />
        <logger name="com.alibaba.druid" level="WARN" />
        <logger name="com.zaxxer.hikari" level="WARN" />
        <logger name="springfox" level="WARN" />
        <logger name="org.apache.http" level="WARN" />
        <logger name="com.netflix.discovery" level="WARN" />
        <logger name="com.alibaba.nacos" level="WARN" />

        <!-- ========== 项目业务日志（详细显示） ========== -->
        <logger name="com.xuecheng" level="DEBUG" />

        <!-- ========== 根日志 ========== -->
        <Root level="INFO" includeLocation="true">
            <AppenderRef ref="AsyncAppender" />
            <AppenderRef ref="Console" />
        </Root>
    </Loggers>
</Configuration>